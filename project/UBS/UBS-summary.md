| 步骤  | 函数/处理         | 函数名/代码行                                       | 主要输入变量                                  | 主要输出变量           | 目的和核心步骤                                | 核心超参数                        | 可能的影响            |
| --- | ------------- | --------------------------------------------- | --------------------------------------- | ---------------- | -------------------------------------- | ---------------------------- | ---------------- |
| 1   | 信号处理          | 约在第23-24行                                     | df_MSFT_signal                          | df_trend         | 将原始信号转换为排序后的趋势信号<br>核心步骤：rank, 归一化     | 无                            | 确定各资产的相对强度       |
| 2   | 计算长期实现方差      | ewma_var_calc 函数                              | df_asset_usd_rate                       | df_lvar          | 评估资产的长期波动性<br>核心步骤：EWMA                | n_lvar = 90                  | 影响风险评估和权重分配      |
| 3   | 计算短期实现方差      | ewma_var_calc 函数                              | df_asset_usd_rate                       | df_svar          | 捕捉资产的短期波动性变化<br>核心步骤：EWMA              | n_svar = 40                  | 有助于及时调整风险敞口      |
| 4   | 计算实现协方差       | ewma_cov_calc 函数                              | df_asset_usd                            | df_covar         | 评估资产间的相关性<br>核心步骤：EWMA                 | 协方差计算窗口                      | 影响投资组合的多样化效果     |
| 5   | RSI计算和映射      | calculate_RSI 和 RSI_range_mapper 函数，约在第26-28行 | df_asset_usd                            | rsi_trend        | 引入动量因子<br>核心步骤：RSI计算，区间映射              | RSI周期 = 20<br>RSI阈值 = 20, 80 | 可能增强趋势跟踪能力       |
| 6   | 平均趋势计算        | 约在第29-30行                                     | df_trend, rsi_trend                     | df_avg_trend     | 平滑化趋势信号<br>核心步骤：加权移动平均                 | 权重 = 0.8 (历史), 0.2 (当前)      | 减少噪音，可能延迟信号反应    |
| 7   | 优化持仓          | _optimal_holdings 函数                          | mtx_var_t, mtx_cov_t, df_avg_trend      | df_w_daily_ts    | 确定最优资产权重<br>核心步骤：凸优化                   | 风险厌恶系数<br>交易成本系数             | 平衡收益、风险和交易成本     |
| 8   | 计算投资组合波动率     | 约在第41-42行                                     | df_W_ref, df_asset_usd_rate             | PtfVol           | 评估整体组合风险<br>核心步骤：滚动方差计算                | 计算窗口 = 20                    | 用于风险管理和敞口调整      |
| 9   | 计算目标波动率敞口     | 约在第43行                                        | PtfVol                                  | df_TV_expo       | 动态调整风险敞口<br>核心步骤：目标波动率除以实际波动率          | 目标波动率 = 5%                   | 有助于维持稳定的风险水平     |
| 10  | 应用权重限制和调整     | 约在第45-46行                                     | df_w_daily_ts, df_TV_expo               | df_W_target      | 确保符合投资限制，控制调整幅度<br>核心步骤：权重上下限约束，调整步长限制 | 最大调整步长 = 5%<br>各资产权重上下限      | 可能限制策略的灵活性，但降低风险 |
| 11  | 计算目标持仓量和实际持仓量 | 约在第47-50行                                     | df_W_target, df_cal_imdts, df_asset_usd | n_target, n_used | 将权重转化为实际交易量<br>核心步骤：根据当前净值和资产价格计算目标持仓  | 最大移动步长 (MMS) = 5%            | 考虑实际执行的限制和成本     |
| 12  | 计算交易成本        | 约在第48-49行                                     | n_used, df_asset_usd                    | df_cost          | 评估策略的实际执行成本<br>核心步骤：基于持仓变化和资产价格计算成本    | 复制成本率<br>再平衡成本率              | 影响策略的净收益         |